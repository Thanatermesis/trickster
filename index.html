<!DOCTYPE html>
<html>
  <head>
    <title>Serivces, Scale, Backgrounding and WTF is going on here?!??!</title>
    <script src="js/lib/jquery-1.8.0.min.js"></script>
    <script src="js/lib/highlight-7.1.min.js"></script>
    <script src="js/conman.js"></script>
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/highlight-solarized_light.min.css">
    <link rel="stylesheet" href="css/styles.css">
    <script>
      $(document).ready(function() {
        Conman = ConmanLoader($,hljs,ConmanDefaultConfig);
        Conman.load();
      });
    </script>
    <style>
      section {
        display: none;
      }
      li {
        visibility: hidden;
      }
    </style>
  </head>
  <body>
    <section class='TITLE'>
<h1>Serivces, Scale, Backgrounding<br> and WTF is going on here?!??!</h1>
<h2>@davetron5000</h2>
<h3>http://www.naildrivin5.com/blog</h3>
</section>
<section class='SECTION'>
<h1>LivingSocial</h1>
</section>
<section class='SECTION'>
<h1>Tech Lead, Payments</h1>
<h2>(i.e. the money)</h2>
</section>
<section class='SECTION'>
<h1>A story</h1>
<h2>about user signup</h2>
<h3>and service-oriented architecture</h3>
</section>
<section class='CODE'>
<pre><code class='ruby'>class PeopleController << ApplicationController
  def create
    @person = Person.create(params[:person])
    if @person.valid?
      redirect_to people_path
    else
      flash[:error] = 'Invalid Data'
      redirect_to new_person_path
    end
  end
end</code></pre>
</section>
<section class='SECTION'>
<h1>Must click link in email to login</h1>
</section>
<section class='CODE'>
<pre><code class='ruby'>def create
  @person = Person.create(params[:person])
  if @person.valid?

    redirect_to people_path
  else
     # ...
  end
end</code></pre>
</section>
<section class='CODE'>
<pre><code class='ruby'>def create
  @person = Person.create(params[:person])
  if @person.valid?
    UserMailer.send_welcome_email(person)
    redirect_to people_path
  else
     # ...
  end
end</code></pre>
</section>
<section class='BULLETS'>
<h1>Sign Up</h1>
<ul>
<li>Enter my stuff</li>
<li>Save to DB</li>
<li>Wait for Mailer</li>
<li>Get bored, leave</li>
</ul>
</section>
<section class='SECTION'>
<h1>I know&hellip;</h1>
</section>
<section class='TITLE'>
<h1>I'll use</h1>
<h2>Background Processing!</h2>
</section>
<section class='CODE'>
<pre><code class='ruby'>def create
  @person = Person.create(params[:person])
  if @person.valid?
    UserMailer.send_welcome_email(person)
    redirect_to people_path
  else
     # ...
  end
end</code></pre>
</section>
<section class='CODE'>
<pre><code class='ruby'>def create
  @person = Person.create(params[:person])
  if @person.valid?
    Resque.enqueue(NewPersonEvent,:id => @person.id)
    redirect_to people_path
  else
     # ...
  end
end</code></pre>
</section>
<section class='CODE'>
<pre><code class='ruby'>class NewPersonEvent
  def self.perform(id)
    person = Person.find(id)
    UserMailer.send_welcome_email(person)
  end
end</code></pre>
</section>
<section class='SECTION'>
<h1>WHEW!</h1>
<h2></h2>
<h3>(or: now I have N+1 problems)</h3>
</section>
<section class='SECTION'>
<h1>Timeout to Redis</h1>
</section>
<section class='CODE'>
<pre><code class='ruby'>def create
  @person = Person.create(params[:person])
  if @person.valid?
    Resque.enqueue(NewPersonEvent,:id => @person.id) # <-- BOOM
    redirect_to people_path
  else
     # ...
  end
end</code></pre>
</section>
<section class='BULLETS'>
<h1>Timeout to Redis</h1>
<ul>
<li>Person created</li>
<li>Email not sent</li>
<li>Person can't be validated</li>
<li>Unique email constraints anyone?</li>
</ul>
</section>
<section class='COMMANDLINE'>
<pre><code>&gt; bundle exec rails console production</code></pre>
</section>
<section class='SECTION'>
<h1>Transactions?</h1>
</section>
<section class='CODE'>
<pre><code class='ruby'>def create
  Person.transaction do
    @person = Person.create(params[:person])
    if @person.valid?
      Resque.enqueue(NewPersonEvent,:id => @person.id)
      redirect_to people_path
    else
       # ...
    end
  end
end</code></pre>
</section>
<section class='BULLETS'>
<h1>WHEW!</h1>
<ul>
<li>If Resque bombs&hellip;</li>
<li>&hellip;we rollback</li>
<li>Could even try again</li>
</ul>
</section>
<section class='SECTION'>
<h1>BUT</h1>
</section>
<section class='CODE'>
<pre><code class='ruby'>class NewPersonEvent
  def self.perform(id)
    person = Person.find(id) # <-- BOOM
    UserMailer.send_welcome_email(person)
  end
end</code></pre>
</section>
<section class='BULLETS'>
<h1><code>ActiveRecord::NotFoundError</code></h1>
<ul>
<li>Event fired</li>
<li>before transaction completed</li>
</ul>
</section>
<section class='SECTION'>
<h1>OH COME ON!</h1>
</section>
<section class='CODE'>
<pre><code class='ruby'>class NewPersonEvent
  MAX_TRIES = 5
  def self.perform(id)
    tried = 0
    person = Person.find_by_id(id)
    while person.nil? && tried < MAX_TRIES
      sleep(tried)
      tried += 1
      person = Person.find_by_id(id)
    end
    if person.nil?
      raise "No such person with id #{id}"
    else
      UserMailer.send_welcome_email(person)
    end
  end
end</code></pre>
</section>
<section class='BULLETS'>
<h1>Better(ish)</h1>
<ul>
<li>Likely to complete in 5 retries</li>
<li>Can replay any that bubble up</li>
<li>Ties up our worker processes retrying</li>
</ul>
</section>
<section class='BULLETS'>
<h1>Bulk Upload some Users</h1>
<ul>
<li>Send welcome emails</li>
<li>Same business logic</li>
</ul>
</section>
<section class='CODE'>
<pre><code class='ruby'>class Person < ActiveRecord::Base
  # ...

  after_create :send_new_person_event

  # ...

private

  def send_new_person_event
    Resque.enqueue(NewPersonEvent,:id => @person.id)
  end
end</code></pre>
</section>
<section class='BULLETS'>
<h1>The best approach?</h1>
<ul>
<li>Maybe not</li>
<li>but certainly <em>reasonable</em></li>
</ul>
</section>
<section class='CODE'>
<pre><code class='ruby'>class Person < ActiveRecord::Base
  # ...

  after_create :send_new_person_event

  # ...

private

  def send_new_person_event
    Resque.enqueue(NewPersonEvent,:id => @person.id)
    Stats.ping(:new_person)
  end
end</code></pre>
</section>
<section class='CODE'>
<pre><code class='ruby'>class Person < ActiveRecord::Base
  # ...

  after_create :send_new_person_event

  # ...

private

  def send_new_person_event
    Resque.enqueue(NewPersonEvent,:id => @person.id)
    Stats.ping(:new_person)
    PersonCache.put(:name,@person.id,@person.name)
  end
end</code></pre>
</section>
<section class='CODE'>
<pre><code class='ruby'>class Person < ActiveRecord::Base
  # ...

  after_create :send_new_person_event

  # ...

private

  def send_new_person_event
    Resque.enqueue(NewPersonEvent,:id => @person.id)
    Stats.ping(:new_person)
    PersonCache.put(:name,@person.id,@person.name)
    PetProject.frobnosticate(
        HexDigest.md5_sha1_hash_rot13(@person.inspect))
  end
end</code></pre>
</section>
<section class='CODE'>
<pre><code class='ruby'>def create
  Person.transaction do
    @person = Person.create(params[:person])
    if @person.valid?
      Resque.enqueue(NewPersonEvent,:id => @person.id)
      redirect_to people_path
    else
       # ...
    end
  end
end</code></pre>
</section>
<section class='CODE'>
<pre><code class='ruby'>def create
  @person = Person.create(params[:person])
  if @person.valid?
    redirect_to people_path
  else
     # ...
  end
end</code></pre>
</section>
<section class='SECTION'>
<h1>NICE!</h1>
</section>
<section class='CODE'>
<pre><code class='ruby'>class NewPersonEvent
  MAX_TRIES = 5
  def self.perform(id)
    tried = 0
    person = Person.find_by_id(id)
    while person.nil? && tried < MAX_TRIES
      sleep(tried)
      tried += 1
      person = Person.find_by_id(id)
    end
    if person.nil?
      raise "No such person with id #{id}"
    else
      UserMailer.send_welcome_email(person)
    end
  end
end</code></pre>
</section>
<section class='SECTION'>
<h1>Clean this up</h1>
</section>
<section class='CODE'>
<pre><code class='ruby'>class NewPersonEvent
  include ResqueRetryOTron

  def self.perform(id)
    person = Person.find_by_id(id)
    retry_on(-> { person.nil? }) do 
      UserMailer.send_welcome_email(person)
    end
  end
end</code></pre>
</section>
<section class='TITLE'>
<h1>More</h1>
<h2>Services</h2>
</section>
<section class='BULLETS'>
<h1>Mailers</h1>
<ul>
<li>Deprecated</li>
<li>New Awesome Mail Service</li>
<li>Just a Simple REST Call</li>
</ul>
</section>
<section class='CODE'>
<pre><code class='ruby'>class NewPersonEvent
  include ResqueRetryOTron

  def self.perform(id)
    person = Person.find_by_id(id)
    retry_on(-> { person.nil? }) do 
      MailerService.mail(:send_welcome_email,person)
    end
  end
end</code></pre>
</section>
<section class='SECTION'>
<h1>Meanwhile&hellip;</h1>
</section>
<section class='SECTION'>
<h1>A Refactoring's Afoot!</h1>
</section>
<section class='CODE'>
<pre><code class='ruby'>def send_new_person_event
  Resque.enqueue(NewPersonEvent,:id => @person.id)
  Stats.ping(:new_person)
  PersonCache.put(:name,@person.id,@person.name)
  PetProject.frobnosticate(
      HexDigest.md5_sha1_hash_rot13(@person.inspect))
end</code></pre>
</section>
<section class='CODE'>
<pre><code class='ruby'>def send_new_person_event
  Resque.enqueue(NewPersonEvent,:id => @person.id)
end</code></pre>
</section>
<section class='CODE'>
<pre><code class='ruby'>def self.perform(id)
  person = Person.find_by_id(id)
  retry_on(-> { person.nil? }) do
    MailerService.mail(:send_welcome_email,person)
    Stats.ping(:new_person)
    PersonCache.put(:name,@person.id,@person.name)
    PetProject.frobnosticate(
        HexDigest.md5_sha1_hash_rot13(@person.inspect))
  end
end</code></pre>
</section>
<section class='BULLETS'>
<h1>A lot can now go wrong</h1>
<ul>
<li><pre><code>MailerService.mail(:send_welcome_email,person)</code></pre></li>
<li><pre><code>Stats.ping(:new_person)</code></pre></li>
<li><pre><code>PersonCache.put(:name,@person.id,@person.name)</code></pre></li>
<li>BOOM</li>
</ul>
</section>
<section class='BULLETS'>
<h1>Just replay!</h1>
<ul>
<li><pre><code>MailerService.mail(:send_welcome_email,person) # Oops, second email</code></pre></li>
<li><pre><code>Stats.ping(:new_person) # Oops, second ping</code></pre></li>
<li><pre><code>PersonCache.put(:name,@person.id,@person.name) # FINALLY! </code></pre></li>
<li>etc.</li>
</ul>
</section>
<section class='SECTION'>
<h1>MailService</h1>
<h2>Abusable by Design</h2>
</section>
<section class='BULLETS'>
<h1>IDEMPOTENT</h1>
<ul>
<li>Operation applied many times</li>
<li>Only the first application has an effect</li>
</ul>
</section>
<section class='CODE'>
<pre><code class='ruby'># Before
class MailerServiceController
  def create
    type = params[:mail_type] # e.g. :welcome_email
    data = params[:data] # e.g. person
    Mailers.find(type).mail(data)
  end
end</code></pre>
</section>
<section class='CODE'>
<pre><code class='ruby'># After
class MailerServiceController
  def create
    type       = params[:mail_type]
    data       = params[:data]
    request_id = params[:request_id]
    client_id  = params[:client_id]

    if request = ClientRequest.find(:request_id => request_id,
                                    :client_id  => client_id)
      respond_with(request)
    else
      results = Mailers.find(type).mail(data)
      respond_with(ClientRequest.create!(:request_id => request_id,
                                         :client_id  => client_id,
                                         :results    => results)
    end
  end
end</code></pre>
</section>
<section class='CODE'>
<pre><code class='ruby'>def self.perform(id)
  person = Person.find_by_id(id)
  retry_on(-> { person.nil? }) do
    MailerService.mail(
      :send_welcome_email,
      person,
      :request_id => "#{:send_welcome_email}/#{@person.id}",
      :client_id => "Monolith")

    Stats.ping(:new_person)
    PersonCache.put(:name,@person.id,@person.name)
    PetProject.frobnosticate(
        HexDigest.md5_sha1_hash_rot13(@person.inspect))
  end
end</code></pre>
</section>
<section class='BULLETS'>
<h1>Call <code>mail</code> a zillion times</h1>
<ul>
<li>Only one mail sent&hellip;ever</li>
<li>Same result goes back</li>
</ul>
</section>
<section class='SECTION'>
<h1>What if the mail fails at the gateway?</h1>
</section>
<section class='SECTION'>
<h1>What if two requests come in at the same time?</h1>
</section>
<section class='IMAGE'>
<img src='images/wtf.png'>
</section>
<section class='SECTION'>
<h1>No system is perfect</h1>
</section>
<section class='TITLE'>
<h1>What can you do?</h1>
</section>
<section class='SECTION'>
<h1>Don't over-engineer</h1>
</section>
<section class='BULLETS'>
<h1>First: Monitor</h1>
<ul>
<li>Log, log, log</li>
<li>Sanity Check invariants</li>
<li>Audit Activity</li>
</ul>
</section>
<section class='BULLETS'>
<h1>Second: Constraints</h1>
<ul>
<li>Database constraints</li>
<li>AR Validations cannot be trusted</li>
<li>Fix bad data</li>
</ul>
</section>
<section class='BULLETS'>
<h1>Third: Deal with Errors</h1>
<ul>
<li>Email <code>redalert@yourcompany.com</code></li>
<li>Fix the problem</li>
<li>Prevent the error</li>
<li>Log warnings</li>
</ul>
</section>
<section class='BULLETS'>
<h1>Fourth: New Services</h1>
<ul>
<li>Prevent client "abuse"</li>
<li>Design for Idempotence</li>
</ul>
</section>
<section class='SECTION'>
<h1>Does this sound fun?</h1>
</section>
<section class='SECTION'>
<h1>We're Hiring</h1>
</section>
<section class='IMAGE'>
<img src='images/book.png'>
</section>
<section class='TITLE'>
<h1>Thank You!</h1>
<h2>@davetron5000</h2>
</section>

  </body>
</html>
